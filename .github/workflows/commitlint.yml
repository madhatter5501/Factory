name: Commit Lint

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  commitlint:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/{cli,config-conventional}

      - name: Create commitlint config
        run: |
          cat > commitlint.config.js << 'EOF'
          module.exports = {
            extends: ['@commitlint/config-conventional'],
            rules: {
              // Type must be one of these
              'type-enum': [2, 'always', [
                'feat',     // New feature
                'fix',      // Bug fix
                'docs',     // Documentation only
                'style',    // Formatting, no code change
                'refactor', // Code change without fix or feature
                'perf',     // Performance improvement
                'test',     // Adding tests
                'build',    // Build system or dependencies
                'ci',       // CI configuration
                'chore',    // Maintenance
                'revert',   // Revert previous commit
                'deps',     // Dependency updates
                'security', // Security fixes
              ]],
              // Subject should not be empty
              'subject-empty': [2, 'never'],
              // Subject should not end with period
              'subject-full-stop': [2, 'never', '.'],
              // Subject should be lowercase
              'subject-case': [2, 'always', 'lower-case'],
              // Type should be lowercase
              'type-case': [2, 'always', 'lower-case'],
              // Type should not be empty
              'type-empty': [2, 'never'],
              // Header max length
              'header-max-length': [2, 'always', 100],
              // Body max line length (warning only)
              'body-max-line-length': [1, 'always', 100],
            },
          };
          EOF

      - name: Validate PR commits
        run: |
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            deps
            security
          requireScope: false
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" doesn't match the required pattern.
            Subject must start with a lowercase letter.
          # For squash merges, PR title becomes commit message
          validateSingleCommit: false
